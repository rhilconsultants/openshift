# CI Pipeline

## Overview
A continuous integration (CI) pipeline should automate all steps needed to create a distribution from source code. This includes, but is not limited to:
* code checkout
* code linting
* code static analysis
* compile the code
* run unit tests
* package the code in a container
* security scan the container image
* push the container to a registry
* deploy the application (can be performed by other tools) to the DEV environment
* run integration tests
* promote the image and deploy on the PRE-PROD (STAGING) environment
* promote the image to the PRODUCTION environment

## Preparing the Respositories
Log into `gitea` as the assigned user.

### Create the Source Code Repository
1. Press the `plus` sign drop down at the top right of the window and select `New Migration`.

1. Press on the `GitHub` icon.

1. For the `Migrate / Clone From URL` field enter: https://github.com/magreenberg/httpserver-ci-demo.git

1. For `Repository Name` enter: httpserver

1. Press the `Migrate Repository` button.

### Create the Deployment Repository
1. Press the `plus` sign drop down at the top right of the window and select `New Migration`.

1. Press on the `GitHub` icon.

1. For the `Migrate / Clone From URL` field enter: https://github.com/magreenberg/httpserver-ci-cd-demo.git

1. For `Repository Name` enter: httpserver-cd

1. Press the `Migrate Repository` button.


### Working With Git

In order to work with Git, we need to provide authentication to our account. The following will create a `Secret` with our account information. First create an environment variable with the assigned password:
```bash
PASSWORD=<assigned-password>
```
Run the following to create the `Secret`:
```bash
oc create -f - <<EOF
apiVersion: v1
kind: Secret
metadata:
  name: gitea-credentials
  annotations:
    tekton.dev/git-0: http://gitea-http-gitea$(oc whoami --show-console | sed "s/.*console-openshift-console//")
type: kubernetes.io/basic-auth
stringData:
  username: $(oc whoami)
  password: $(oc whoami)
EOF
```
The output should be:
```
secret/gitea-credentials created
```

Review the hostname generated by the script above by running:
```bash
oc get secret gitea-credentials -o yaml | grep "git-0:"
```
This hostname must match the hostname of the Git repository.

```bash
oc patch serviceaccount pipeline -p '{"secrets": [{"name": "gitea-credentials"}]}'
```
## Pipeline Tasks

We will now build a Continuous Integration `Pipeline` with the following steps:
  * Checkout the latest source code from Git
  * Build the `Dockerfile` and push the resulting image to an image repository
  * Update the deployment files with the image tag of the newly built image
  * Deploy the application to OpenShift


Create a `Pipeline` by copying the following to a file named `ci-pipeline.yaml`:

```yaml
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: ci-pipeline
spec:
  workspaces:
    - name: shared-data
  params:
  - name: git-source-url
    type: string
  - name: git-cd-url
    type: string
  - name: image
    type: string
  - name: release-name
    type: string
  - name: namespace
    type: string
  - name: deploy
    type: string
  tasks:
  - name: clone-sources
    taskRef:
      kind: ClusterTask
      name: git-clone
    params:
      - name: url
        value: $(params.git-source-url)
    workspaces:
      - name: output
        workspace: shared-data
  - name: build-and-push
    taskRef:
      kind: ClusterTask
      name: buildah
    params:
      - name: IMAGE
        value: $(params.image):$(tasks.clone-sources.results.commit)
    workspaces:
      - name: source
        workspace: shared-data
    runAfter:
      - clone-sources
  - name: update-deployment-repo
    taskRef:
      kind: ClusterTask
      name: git-cli
    params:
      - name: GIT_USER_NAME
        value: pipelinetask
      - name: GIT_SCRIPT
        value: "set -x; GIT_TRACE=2 GIT_CURL_VERBOSE=2 git clone $(params.git-cd-url) cd-repo;cd cd-repo;sed -i \"s@repositoryandtag:.*@repositoryandtag: $(params.image):$(tasks.clone-sources.results.commit)@\" values.yaml;git commit -a -m \"updated image tag\" --allow-empty;GIT_TRACE=2 GIT_CURL_VERBOSE=2 git push"
    workspaces:
      - name: source
        workspace: shared-data
    runAfter:
      - build-and-push
  - name: deploy-application
    when:
      - input: "$(params.deploy)"
        operator: in
        values: ["true"]
    taskRef:
      kind: ClusterTask
      name: helm-upgrade-from-source
    params:
      - name: charts_dir
        value: cd-repo
      - name: release_namespace
        value: $(params.namespace)
      - name: release_name
        value: "$(params.release-name)"
    workspaces:
      - name: source
        workspace: shared-data
    runAfter:
      - update-deployment-repo
```

Create the `Pipeline` by running:
```bash
oc create -f ci-pipeline.yaml
```

Review the `Tasks` in the OpenShift web console.

Note that this `Pipeline` uses `workspaces`. These are used to pass information in a file system between `Tasks`. The storage areas are Persistent Volume Claims that need to be provided when the `Pipeline` is run.

The `Pipeline` also uses a conditional `Task`. 

We will now create a `PipelineRun` to run the `Pipeline`. Run the following to create a file named `ci-pipeline-run`.yaml:
```bash
cat > ci-pipeline-run.yaml <<EOF
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: ci-pipeline-run
spec:
  pipelineRef:
    name: ci-pipeline
  params:
    - name: git-source-url
      value: http://gitea-http-gitea$(oc whoami --show-console | sed "s/.*console-openshift-console//")/$(oc whoami)/httpserver.git
    - name: git-cd-url
      value: http://gitea-http-gitea$(oc whoami --show-console | sed "s/.*console-openshift-console//")/$(oc whoami)/httpserver-cd.git
    - name: image
      value: image-registry.openshift-image-registry.svc:5000/$(oc whoami)/httpserver
    - name: release-name
      value: httpserver
    - name: namespace
      value: $(oc whoami)
    - name: deploy
      value: true
  workspaces:
    - name: shared-data
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 5Gi
EOF
```

Note the parameters generated for the `PipelineRun`.

QUESTION: What values should be used for your office environment?

Start the `PipelineRun` by running:
```bash
oc create -f ci-pipeline-run.yaml
```

Track the status of your build either in the OpenShift web console or using the `tkn` command.

ASSIGNMENT:

Add a [Task](https://tekton.dev/docs/pipelines/tasks/) to the `Pipeline` that `lints` the source code.

Make this task conditional using [when expressions](https://tekton.dev/docs/pipelines/pipelines/#guard-task-execution-using-when-expressions) based on a variable in the `PipelineRun`.


# IDE Plugins

IDE Plugins are available for Tekton to assist in creating and viewing the `Pipeline` objects:
  * Visual Studio Code
  * IntelliJ

The following image displays some of the features available in the Visual Studio Code plug:
<img alt="Visual Studio Code Tekton Plugin" src="vscode-plugin.jpg" width="100%" height="100%">


We will wait for the rest of the class to complete the exercise and move on to [Exercise 4](../Exercise-4/README.md).
